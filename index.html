<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura e PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos personalizados para o botÃ£o de arquivo ficar invisÃ­vel */
        .custom-file-input {
            width: 100%;
            height: 100%;
            opacity: 0;
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        /* Garantindo que o corpo use a fonte Inter */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            ðŸ“¸ Captura MÃ³vel para PDF
        </h1>

        <div class="relative mb-6">
            <label for="inputImagem" class="block text-sm font-medium text-gray-700 mb-2">
                Passo 1: Capturar Foto ou Selecionar Imagem
            </label>
            
            <div class="flex flex-col sm:flex-row gap-4">
                
                <div class="relative flex-1">
                    <button id="btnCapturar" class="w-full h-12 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        <span id="captureText">Abrir CÃ¢mera / Galeria</span>
                    </button>
                    <input 
                        type="file" 
                        accept="image/*" 
                        capture="environment" 
                        id="inputImagem" 
                        class="custom-file-input"
                    >
                </div>

                <div class="relative flex-1">
                    <button id="btnGaleria" class="w-full h-12 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150">
                        Selecionar na Galeria
                    </button>
                    <input 
                        type="file" 
                        accept="image/*" 
                        id="inputGaleria" 
                        class="custom-file-input"
                    >
                </div>
            </div>
        </div>

        <div id="previewContainer" class="mb-6 h-64 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden">
            <p id="previewPlaceholder" class="text-gray-400 text-center p-4">
                A imagem capturada ou selecionada aparecerÃ¡ aqui.
            </p>
            <img id="imagePreview" class="hidden w-full h-full object-contain" src="#" alt="PrÃ©-visualizaÃ§Ã£o da Imagem">
        </div>

        <button 
            id="btnConverter" 
            onclick="converterParaPDF()" 
            disabled 
            class="w-full py-3 bg-green-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-600 transition duration-150 disabled:bg-green-300"
        >
            Passo 3: Converter e Baixar PDF
        </button>

        <p id="statusMessage" class="text-center text-sm mt-4 text-gray-600">
            Desenvolvido por Ricardo Sousa        </p>
    </div>

    <script>
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const imagePreview = document.getElementById('imagePreview');
        const btnConverter = document.getElementById('btnConverter');
        const statusMessage = document.getElementById('statusMessage');
        const inputImagem = document.getElementById('inputImagem'); // O input da cÃ¢mera
        const inputGaleria = document.getElementById('inputGaleria'); // O input da galeria
        
        // Adiciona os event listeners diretamente nos inputs
        inputImagem.addEventListener('change', mostrarPreview);
        inputGaleria.addEventListener('change', mostrarPreview);
        
        let imagemBase64 = null; 

        // FunÃ§Ã£o para prÃ©-visualizar a imagem e armazenar o Base64
        function mostrarPreview(event) {
            const arquivo = event.target.files[0];

            if (!arquivo) {
                // Limpa o estado se o usuÃ¡rio cancelar a seleÃ§Ã£o
                imagemBase64 = null;
                imagePreview.classList.add('hidden');
                previewPlaceholder.classList.remove('hidden');
                btnConverter.disabled = true;
                statusMessage.textContent = "SeleÃ§Ã£o cancelada. Selecione uma imagem para comeÃ§ar.";
                return;
            }
            
            // Corrige o erro de limpar o input ativo:
            if (event.target.id === 'inputImagem') {
                // Se o arquivo veio da CÃ‚MERA, limpe o input da GALERIA.
                inputGaleria.value = '';
            } else if (event.target.id === 'inputGaleria') {
                // Se o arquivo veio da GALERIA, limpe o input da CÃ‚MERA.
                inputImagem.value = '';
            }

            statusMessage.textContent = "Carregando prÃ©-visualizaÃ§Ã£o...";

            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Armazena o Base64 para uso futuro na conversÃ£o
                imagemBase64 = e.target.result; 
                
                // Mostra a prÃ©-visualizaÃ§Ã£o
                imagePreview.src = imagemBase64;
                imagePreview.classList.remove('hidden');
                previewPlaceholder.classList.add('hidden');
                
                // Habilita o botÃ£o de conversÃ£o
                btnConverter.disabled = false;
                statusMessage.textContent = "Imagem carregada. Clique em 'Converter e Baixar PDF'.";
            };

            reader.onerror = function() {
                statusMessage.textContent = "Erro ao carregar o arquivo.";
            };

            reader.readAsDataURL(arquivo);
        }

        // FunÃ§Ã£o para realizar a conversÃ£o de fato
        async function converterParaPDF() {
            if (!imagemBase64) {
                statusMessage.textContent = "Nenhuma imagem para converter. Por favor, selecione ou capture uma foto.";
                return;
            }

            btnConverter.disabled = true;
            statusMessage.textContent = "Convertendo para PDF, aguarde...";
            
            // Cria um objeto Image temporÃ¡rio para obter as dimensÃµes reais
            const img = new Image();
            img.onload = function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // A4: 210mm x 297mm

                const larguraOriginal = img.width;
                const alturaOriginal = img.height;
                const larguraA4 = 210;
                const alturaA4 = 297;

                // Calcula o redimensionamento para ajustar ao A4 mantendo a proporÃ§Ã£o
                const proporcao = larguraOriginal / alturaOriginal;
                
                let larguraPDF = larguraA4;
                let alturaPDF = larguraA4 / proporcao;

                // Se a altura calculada for maior que o A4, reajusta pela altura
                if (alturaPDF > alturaA4) {
                    alturaPDF = alturaA4;
                    larguraPDF = alturaA4 * proporcao;
                }
                
                // Centraliza a imagem na pÃ¡gina
                const x = (larguraA4 - larguraPDF) / 2;
                const y = (alturaA4 - alturaPDF) / 2;

                // Tenta determinar o tipo de imagem
                const mimeType = imagemBase64.substring(5, imagemBase64.indexOf(';'));
                const imgFormat = mimeType.includes('png') ? 'PNG' : 'JPEG';

                // Adiciona a imagem ao documento PDF
                doc.addImage(imagemBase64, imgFormat, x, y, larguraPDF, alturaPDF);

                // Salva e baixa o arquivo
                const dataAtual = new Date().toISOString().slice(0, 10);
                doc.save(`digitalizacao_${dataAtual}.pdf`);

                statusMessage.textContent = "âœ… PDF gerado e baixado com sucesso! VocÃª pode capturar outra imagem.";
                btnConverter.disabled = false;
            };
            img.src = imagemBase64;
        }
    </script>
</body>
</html>